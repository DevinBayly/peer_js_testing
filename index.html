<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <title>Document</title>
</head>

<body>
    <button onclick="startServer()">server</button>
    <button onclick="startClient()">client</button>
    <button onclick="getMedia()">ServerInitiateCall</button>
    <button onclick="clientCall()">ClientInitiateCall</button>
    <button onclick="sendData()">sendData</button>
    <video src=""></video>
    <script>
        var peer
        var conn
        function startServer() {
            peer = new Peer("server", {
                host: "192.168.2.105",
                port: 9000,
                path: "/myapp"
            })
            peer.on("open", function (id) {
                console.log("my id is", id)
                let p = document.createElement("p")
                p.innerHTML = id
                document.body.append(p)

            })
            peer.on("connection", function (con) {
                console.log("just connected to!", con)
                conn = con
                conn.on("data", function (data) {
                    console.log("got data!", data)
                    let dataj = JSON.parse(data)
                    if (dataj.cmd === "startMedia") {
                        sendMediaToPeer(dataj.pid)
                    }
                })
            })
            

        }
        function startClient() {
            peer = new Peer(undefined, {
                host: "192.168.2.105",
                port: 9000,
                path: "/myapp"
            })
            peer.on("open", function (id) {
                console.log("my id is", id)
                let p = document.createElement("p")
                p.innerHTML = id
                document.body.append(p)
                conn = peer.connect("server")
                console.log("connected to server")

            })
            peer.on("call", function (call) {
                call.answer()
                call.on("stream", function (stream) {
                    var video = document.querySelector('video');
                    video.srcObject = stream;
                    video.onloadedmetadata = function (e) {
                        video.play();
                    };
                })
            })


        }
        function clientCall() {
            // instead make this a data transfer that tells the server which client to send video to
            conn.send(JSON.stringify({cmd:"startMedia",pid:peer.id}))
        }
        function sendData() {
            setInterval(() => {
                conn.send(JSON.stringify({ numbers: Math.random() }))
            }, 1000)
        }
        function attachStreamToVideo(stream) {
            var video = document.querySelector('video');
            video.srcObject = stream;
            video.onloadedmetadata = function (e) {
                // Do something with the video here.
            };
        }
        function sendMediaToPeer(pid) {
            navigator.getUserMedia = navigator.mozGetUserMedia || navigator.mediaDevices.getUserMedia
            navigator.getUserMedia({ video: { width: 1280, height: 720 } },
                function (stream) {

                    peer.call(pid, stream)
                },
                function (err) {
                    console.log("The following error occurred: " + err.name);
                }
            );
        } function getMedia() {
            navigator.getUserMedia = navigator.mozGetUserMedia || navigator.mediaDevices.getUserMedia
            navigator.getUserMedia({ video: { width: 1280, height: 720 } },
                function (stream) {

                    peer.call(conn.peer, stream)
                },
                function (err) {
                    console.log("The following error occurred: " + err.name);
                }
            );
        }

        //every client knows the name of the server,
        // only one server

    </script>
</body>

</html>